# 服务器配置修复说明

## 问题原因

上传到服务器后功能与本地不一致，主要原因是：

1. **缺少Docker环境配置文件**：没有 `application-docker.properties`
2. **邮件配置未传递**：Docker环境变量中没有邮件相关配置
3. **配置覆盖问题**：Spring Boot在Docker环境中需要明确的环境变量

## 已修复的内容

### 1. 创建了 `application-docker.properties`
- 专门用于Docker环境的配置
- 数据库和邮件配置通过环境变量覆盖

### 2. 更新了 `compose.yaml`
- 添加了所有邮件相关的环境变量
- 确保配置与本地一致

## 修复后的配置

### compose.yaml 中的环境变量

```yaml
environment:
  - SPRING_PROFILES_ACTIVE=docker
  - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/network_homework?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
  - SPRING_DATASOURCE_USERNAME=network_user
  - SPRING_DATASOURCE_PASSWORD=wkm20040818@
  - SPRING_MAIL_HOST=smtp.qq.com
  - SPRING_MAIL_PORT=587
  - SPRING_MAIL_USERNAME=937238852@qq.com
  - SPRING_MAIL_PASSWORD=akxpzriwzxifbefd
  - SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH=true
  - SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE=true
  - SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_REQUIRED=true
  - SPRING_MAIL_PROPERTIES_MAIL_SMTP_SSL_ENABLE=false
  - SPRING_MAIL_DEFAULT_ENCODING=UTF-8
  - SPRING_MAIL_FROM=937238852@qq.com
```

## 部署步骤

### 方法一：重新上传修复后的文件（推荐）

1. **上传修复后的文件**：
   ```powershell
   # 上传compose.yaml
   scp network-homework/compose.yaml ubuntu@114.132.150.59:/opt/network-homework/
   
   # 上传application-docker.properties
   scp network-homework/src/main/resources/application-docker.properties ubuntu@114.132.150.59:/opt/network-homework/src/main/resources/
   ```

2. **在服务器上重新部署**：
   ```bash
   cd /opt/network-homework
   docker-compose down
   docker-compose up -d --build
   ```

### 方法二：在服务器上直接修复

1. **创建application-docker.properties**：
   ```bash
   cd /opt/network-homework
   mkdir -p src/main/resources
   nano src/main/resources/application-docker.properties
   ```
   
   复制以下内容：
   ```properties
   # Docker环境配置
   spring.application.name=network-homework
   
   # 数据库配置（通过环境变量覆盖）
   spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
   spring.jpa.hibernate.ddl-auto=update
   spring.jpa.show-sql=false
   
   # 禁用Docker Compose自动配置
   spring.docker.compose.enabled=false
   
   # 邮件配置（通过环境变量覆盖）
   spring.mail.default-encoding=UTF-8
   ```

2. **更新compose.yaml**：
   ```bash
   nano compose.yaml
   ```
   
   在 `app` 服务的 `environment` 部分添加邮件配置（参考上面的配置）

3. **重新部署**：
   ```bash
   docker-compose down
   docker-compose up -d --build
   ```

## 验证修复

部署完成后，检查：

1. **查看日志**：
   ```bash
   docker-compose logs app | grep -i "mail\|started"
   ```

2. **测试功能**：
   - 注册新用户（应该能收到邮件）
   - 创建订单并支付（应该能收到订单确认邮件）
   - 管理员发货（应该能收到发货通知邮件）

3. **检查配置**：
   ```bash
   # 进入容器查看环境变量
   docker exec network-homework-app env | grep SPRING
   ```

## 常见问题

### Q: 邮件仍然无法发送？
**A**: 检查：
1. 邮件配置是否正确传递到容器
2. QQ邮箱授权码是否正确
3. 服务器网络是否能访问smtp.qq.com

### Q: 数据库连接失败？
**A**: 检查：
1. MySQL容器是否正常运行
2. 密码是否正确
3. 环境变量是否正确传递

### Q: 功能仍然不一致？
**A**: 检查：
1. 是否使用了正确的profile（docker）
2. 环境变量是否正确传递
3. 查看应用日志确认配置加载情况

## 配置对比

### 本地环境（application.properties）
- 数据库：localhost:3306，用户root，密码1234
- 邮件：直接配置在properties文件中

### Docker环境（application-docker.properties + 环境变量）
- 数据库：mysql:3306，用户network_user，密码wkm20040818@
- 邮件：通过环境变量配置

这样确保了两种环境配置的一致性。

