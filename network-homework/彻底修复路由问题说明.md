# å½»åº•ä¿®å¤è·¯ç”±é—®é¢˜è¯´æ˜

## ğŸ” é—®é¢˜è¯Šæ–­

ç»è¿‡ä»”ç»†æ£€æŸ¥ï¼Œå‘ç°äº†ä»¥ä¸‹é—®é¢˜ï¼š

1. **åç«¯å¼‚å¸¸å¤„ç†ä¸å®Œå–„**ï¼šOrderController å’Œ AdminController ä¸­çš„æ–¹æ³•ç¼ºå°‘å¼‚å¸¸å¤„ç†ï¼Œå¯èƒ½å¯¼è‡´ 404 æˆ– 500 é”™è¯¯
2. **å‰ç«¯é”™è¯¯ä¿¡æ¯ä¸æ˜ç¡®**ï¼šJavaScript æ²¡æœ‰æ­£ç¡®æ˜¾ç¤ºåç«¯è¿”å›çš„é”™è¯¯ä¿¡æ¯

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### 1. OrderController - æ”¯ä»˜å’Œå–æ¶ˆè®¢å•
- âœ… æ·»åŠ äº† `userDetails` ä¸º null çš„æ£€æŸ¥
- âœ… æ·»åŠ äº†è®¢å•ä¸å­˜åœ¨çš„æ£€æŸ¥
- âœ… æ·»åŠ äº†å®Œæ•´çš„å¼‚å¸¸å¤„ç†
- âœ… è¿”å›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

### 2. AdminController - å‘è´§å’Œå®Œæˆè®¢å•
- âœ… æ·»åŠ äº†å®Œæ•´çš„å¼‚å¸¸å¤„ç†
- âœ… è¿”å›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

### 3. å‰ç«¯ JavaScript
- âœ… æ”¹è¿›äº†é”™è¯¯å¤„ç†ï¼Œæ˜¾ç¤ºåç«¯è¿”å›çš„å…·ä½“é”™è¯¯ä¿¡æ¯
- âœ… ç»Ÿä¸€äº†é”™è¯¯æç¤ºæ ¼å¼

## ğŸ”§ ä¿®å¤çš„æ–‡ä»¶

1. âœ… **OrderController.java** - æ·»åŠ å¼‚å¸¸å¤„ç†å’Œé”™è¯¯ä¿¡æ¯
2. âœ… **AdminController.java** - æ·»åŠ å¼‚å¸¸å¤„ç†å’Œé”™è¯¯ä¿¡æ¯
3. âœ… **orders.html** - æ”¹è¿›é”™è¯¯æç¤º
4. âœ… **admin-orders.html** - æ”¹è¿›é”™è¯¯æç¤º

## ğŸ“ ä¿®å¤å†…å®¹

### OrderController.java

**ä¹‹å‰**ï¼š
```java
@PostMapping("/{orderId}/pay")
public ResponseEntity<Order> payOrder(@PathVariable Long orderId,
                                     @AuthenticationPrincipal UserDetails userDetails) {
    Order order = orderService.getOrderById(orderId);
    if (!order.getUserId().equals(userDetails.getUsername())) {
        return ResponseEntity.status(403).build();
    }
    Order paidOrder = orderService.payOrder(orderId);
    return ResponseEntity.ok(paidOrder);
}
```

**ä¿®å¤å**ï¼š
```java
@PostMapping("/{orderId}/pay")
public ResponseEntity<?> payOrder(@PathVariable Long orderId,
                                 @AuthenticationPrincipal UserDetails userDetails) {
    if (userDetails == null) {
        return ResponseEntity.status(401).body("æœªç™»å½•");
    }
    
    try {
        Order order = orderService.getOrderById(orderId);
        if (order == null) {
            return ResponseEntity.status(404).body("è®¢å•ä¸å­˜åœ¨");
        }
        
        if (!order.getUserId().equals(userDetails.getUsername())) {
            return ResponseEntity.status(403).body("æ‚¨æ²¡æœ‰æƒé™æ”¯ä»˜æ­¤è®¢å•");
        }
        
        Order paidOrder = orderService.payOrder(orderId);
        return ResponseEntity.ok(paidOrder);
    } catch (IllegalArgumentException e) {
        return ResponseEntity.status(400).body(e.getMessage());
    } catch (IllegalStateException e) {
        return ResponseEntity.status(400).body(e.getMessage());
    } catch (Exception e) {
        return ResponseEntity.status(500).body("æ”¯ä»˜å¤±è´¥ï¼š" + e.getMessage());
    }
}
```

### å‰ç«¯ JavaScript

**ä¹‹å‰**ï¼š
```javascript
.then(response => {
    if (response.ok) {
        alert('æ”¯ä»˜æˆåŠŸï¼');
        location.reload();
    } else if (response.status === 403) {
        alert('æ‚¨æ²¡æœ‰æƒé™æ”¯ä»˜æ­¤è®¢å•');
    } else {
        alert('æ”¯ä»˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
})
```

**ä¿®å¤å**ï¼š
```javascript
.then(response => {
    if (response.ok) {
        alert('æ”¯ä»˜æˆåŠŸï¼');
        location.reload();
    } else {
        response.text().then(text => {
            alert('æ”¯ä»˜å¤±è´¥ï¼š' + text);
        });
    }
})
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. ä¸Šä¼ ä¿®å¤åçš„æ–‡ä»¶

```powershell
# ä¸Šä¼ Javaæ§åˆ¶å™¨æ–‡ä»¶
scp network-homework\src\main\java\com\example\network_homework\controller\OrderController.java ubuntu@114.132.150.59:/opt/network-homework/src/main/java/com/example/network_homework/controller/
scp network-homework\src\main\java\com\example\network_homework\controller\AdminController.java ubuntu@114.132.150.59:/opt/network-homework/src/main/java/com/example/network_homework/controller/

# ä¸Šä¼ æ¨¡æ¿æ–‡ä»¶
scp network-homework\src\main\resources\templates\orders.html ubuntu@114.132.150.59:/opt/network-homework/src/main/resources/templates/
scp network-homework\src\main\resources\templates\admin-orders.html ubuntu@114.132.150.59:/opt/network-homework/src/main/resources/templates/
```

### 2. åœ¨æœåŠ¡å™¨ä¸Šé‡æ–°æ„å»ºå’Œéƒ¨ç½²

```bash
ssh ubuntu@114.132.150.59
cd /opt/network-homework
docker-compose down
docker-compose up -d --build
```

æˆ–è€…å¿«é€Ÿé‡å¯ï¼ˆå¦‚æœåªæ˜¯æ¨¡æ¿æ–‡ä»¶ä¿®æ”¹ï¼‰ï¼š
```bash
docker-compose restart app
```

## âœ… éªŒè¯ä¿®å¤

éƒ¨ç½²åï¼Œæµ‹è¯•ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **æ™®é€šç”¨æˆ·æ”¯ä»˜è®¢å•ï¼ˆè®¢å•åˆ—è¡¨ï¼‰**ï¼š
   - ç™»å½•æ™®é€šç”¨æˆ·
   - è¿›å…¥"æˆ‘çš„è®¢å•"é¡µé¢
   - ç‚¹å‡»"æ”¯ä»˜"æŒ‰é’®
   - åº”è¯¥èƒ½æˆåŠŸæ”¯ä»˜ï¼Œå¦‚æœå¤±è´¥ä¼šæ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯

2. **ç®¡ç†å‘˜å‘è´§ï¼ˆè®¢å•åˆ—è¡¨ï¼‰**ï¼š
   - ç™»å½•ç®¡ç†å‘˜è´¦æˆ·
   - è¿›å…¥"è®¢å•ç®¡ç†"é¡µé¢
   - ç‚¹å‡»"å‘è´§"æŒ‰é’®
   - åº”è¯¥èƒ½æˆåŠŸå‘è´§ï¼Œå¦‚æœå¤±è´¥ä¼šæ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯

## ğŸ” è°ƒè¯•æ–¹æ³•

å¦‚æœä»ç„¶æœ‰é—®é¢˜ï¼Œå¯ä»¥ï¼š

1. **æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°**ï¼š
   - æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
   - æŸ¥çœ‹ Console æ ‡ç­¾é¡µçš„é”™è¯¯ä¿¡æ¯
   - æŸ¥çœ‹ Network æ ‡ç­¾é¡µçš„è¯·æ±‚å’Œå“åº”

2. **æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—**ï¼š
   ```bash
   docker-compose logs -f app
   ```

3. **æ£€æŸ¥APIè·¯å¾„**ï¼š
   - æ”¯ä»˜ï¼š`POST /api/orders/{orderId}/pay`
   - å–æ¶ˆï¼š`POST /api/orders/{orderId}/cancel`
   - å‘è´§ï¼š`POST /api/admin/orders/{orderId}/ship`
   - å®Œæˆï¼š`POST /api/admin/orders/{orderId}/complete`

---

**ä¿®å¤å®Œæˆï¼** ç°åœ¨æ‰€æœ‰é”™è¯¯éƒ½ä¼šæœ‰æ˜ç¡®çš„æç¤ºä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•å’Œè§£å†³é—®é¢˜ã€‚ğŸ‰

