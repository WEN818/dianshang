# è´­ç‰©è½¦åˆå¹¶åŠŸèƒ½ä¿®å¤è¯´æ˜

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### é—®é¢˜ï¼šé‡å¤å•†å“æ²¡æœ‰åˆå¹¶
**åŸå› **ï¼šåœ¨ `CartService.addToCart` æ–¹æ³•ä¸­ï¼Œæ¯æ¬¡æ·»åŠ å•†å“æ—¶éƒ½ç›´æ¥åˆ›å»ºæ–°çš„ `CartItem`ï¼Œæ²¡æœ‰æ£€æŸ¥è¯¥ç”¨æˆ·æ˜¯å¦å·²ç»æœ‰è¿™ä¸ªå•†å“åœ¨è´­ç‰©è½¦ä¸­ã€‚

**ä¿®å¤**ï¼š
1. åœ¨ `CartItemRepository` ä¸­æ·»åŠ äº† `findByUserIdAndProductId` æ–¹æ³•
2. ä¿®æ”¹äº† `CartService.addToCart` æ–¹æ³•ï¼Œå¦‚æœè´­ç‰©è½¦ä¸­å·²å­˜åœ¨è¯¥å•†å“ï¼Œåˆ™æ›´æ–°æ•°é‡ï¼ˆç´¯åŠ ï¼‰ï¼Œå¦åˆ™åˆ›å»ºæ–°é¡¹

## ğŸ”§ ä¿®å¤çš„æ–‡ä»¶

1. âœ… **CartItemRepository.java** - æ·»åŠ äº† `findByUserIdAndProductId` æ–¹æ³•
2. âœ… **CartService.java** - ä¿®æ”¹äº† `addToCart` æ–¹æ³•ï¼Œå®ç°å•†å“åˆå¹¶é€»è¾‘
3. âœ… **cart.html** - æ·»åŠ äº†ç©ºè´­ç‰©è½¦æç¤ºå’Œæ“ä½œåˆ—æ ‡é¢˜

## ğŸ“ ä¿®å¤å†…å®¹

### CartItemRepository.java

**æ–°å¢æ–¹æ³•**ï¼š
```java
Optional<CartItem> findByUserIdAndProductId(String userId, Long productId);
```

### CartService.java

**ä¹‹å‰çš„é€»è¾‘**ï¼š
```java
@Transactional
public CartItem addToCart(String userId, Long productId, Integer quantity) {
    Product product = productRepository.findActiveById(productId)
            .orElseThrow(() -> new IllegalArgumentException("å•†å“ä¸å­˜åœ¨"));
    
    CartItem cartItem = new CartItem();
    cartItem.setUserId(userId);
    cartItem.setProduct(product);
    cartItem.setQuantity(quantity);
    return cartItemRepository.save(cartItem);
}
```

**ä¿®å¤åçš„é€»è¾‘**ï¼š
```java
@Transactional
public CartItem addToCart(String userId, Long productId, Integer quantity) {
    Product product = productRepository.findActiveById(productId)
            .orElseThrow(() -> new IllegalArgumentException("å•†å“ä¸å­˜åœ¨"));
    
    if (product.getDeleted() != null && product.getDeleted()) {
        throw new IllegalArgumentException("å•†å“å·²ä¸‹æ¶");
    }

    // æ£€æŸ¥è´­ç‰©è½¦ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥å•†å“
    Optional<CartItem> existingItem = cartItemRepository.findByUserIdAndProductId(userId, productId);
    
    if (existingItem.isPresent()) {
        // å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°æ•°é‡ï¼ˆç´¯åŠ ï¼‰
        CartItem cartItem = existingItem.get();
        cartItem.setQuantity(cartItem.getQuantity() + quantity);
        return cartItemRepository.save(cartItem);
    } else {
        // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„è´­ç‰©è½¦é¡¹
        CartItem cartItem = new CartItem();
        cartItem.setUserId(userId);
        cartItem.setProduct(product);
        cartItem.setQuantity(quantity);
        return cartItemRepository.save(cartItem);
    }
}
```

## ğŸ¯ åŠŸèƒ½è¯´æ˜

### åˆå¹¶é€»è¾‘
- **é¦–æ¬¡æ·»åŠ **ï¼šå¦‚æœè´­ç‰©è½¦ä¸­æ²¡æœ‰è¯¥å•†å“ï¼Œåˆ›å»ºæ–°çš„è´­ç‰©è½¦é¡¹
- **é‡å¤æ·»åŠ **ï¼šå¦‚æœè´­ç‰©è½¦ä¸­å·²æœ‰è¯¥å•†å“ï¼Œå°†æ–°æ·»åŠ çš„æ•°é‡ç´¯åŠ åˆ°ç°æœ‰æ•°é‡ä¸Š
- **ç¤ºä¾‹**ï¼š
  - ç¬¬ä¸€æ¬¡æ·»åŠ  iPhoneï¼Œæ•°é‡ä¸º 1 â†’ è´­ç‰©è½¦ä¸­æœ‰ 1 ä¸ª iPhone
  - å†æ¬¡æ·»åŠ  iPhoneï¼Œæ•°é‡ä¸º 2 â†’ è´­ç‰©è½¦ä¸­æœ‰ 3 ä¸ª iPhoneï¼ˆ1 + 2ï¼‰

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ–¹æ³•ä¸€ï¼šä¸Šä¼ ä¿®å¤åçš„æ–‡ä»¶

```powershell
# ä¸Šä¼ Javaæ–‡ä»¶
scp network-homework\src\main\java\com\example\network_homework\repository\CartItemRepository.java ubuntu@114.132.150.59:/opt/network-homework/src/main/java/com/example/network_homework/repository/
scp network-homework\src\main\java\com\example\network_homework\service\CartService.java ubuntu@114.132.150.59:/opt/network-homework/src/main/java/com/example/network_homework/service/

# ä¸Šä¼ æ¨¡æ¿æ–‡ä»¶
scp network-homework\src\main\resources\templates\cart.html ubuntu@114.132.150.59:/opt/network-homework/src/main/resources/templates/
```

ç„¶ååœ¨æœåŠ¡å™¨ä¸Šï¼š
```bash
cd /opt/network-homework
docker-compose down
docker-compose up -d --build
```

### æ–¹æ³•äºŒï¼šä¸Šä¼ æ•´ä¸ªç›®å½•

```powershell
# ä¸Šä¼ repositoryç›®å½•
scp -r network-homework\src\main\java\com\example\network_homework\repository ubuntu@114.132.150.59:/opt/network-homework/src/main/java/com/example/network_homework/

# ä¸Šä¼ serviceç›®å½•
scp -r network-homework\src\main\java\com\example\network_homework\service ubuntu@114.132.150.59:/opt/network-homework/src/main/java/com/example/network_homework/

# ä¸Šä¼ templatesç›®å½•
scp -r network-homework\src\main\resources\templates ubuntu@114.132.150.59:/opt/network-homework/src/main/resources/
```

ç„¶ååœ¨æœåŠ¡å™¨ä¸Šï¼š
```bash
cd /opt/network-homework
docker-compose down
docker-compose up -d --build
```

## âœ… éªŒè¯ä¿®å¤

éƒ¨ç½²åï¼Œæµ‹è¯•ä»¥ä¸‹åœºæ™¯ï¼š

1. **é¦–æ¬¡æ·»åŠ å•†å“**ï¼š
   - åœ¨å•†å“åˆ—è¡¨é¡µé¢ï¼Œæ·»åŠ ä¸€ä¸ªå•†å“åˆ°è´­ç‰©è½¦
   - æ£€æŸ¥è´­ç‰©è½¦ï¼Œåº”è¯¥æ˜¾ç¤ºè¯¥å•†å“ï¼Œæ•°é‡ä¸ºæ·»åŠ çš„æ•°é‡

2. **é‡å¤æ·»åŠ ç›¸åŒå•†å“**ï¼š
   - åœ¨å•†å“åˆ—è¡¨é¡µé¢ï¼Œå†æ¬¡æ·»åŠ ç›¸åŒçš„å•†å“ï¼ˆå¯ä»¥æ˜¯ä¸åŒæ•°é‡ï¼‰
   - æ£€æŸ¥è´­ç‰©è½¦ï¼Œåº”è¯¥åªæ˜¾ç¤ºä¸€è¡Œè¯¥å•†å“ï¼Œæ•°é‡ä¸ºç´¯åŠ åçš„æ€»æ•°
   - **ä¸åº”è¯¥**å‡ºç°å¤šè¡Œç›¸åŒçš„å•†å“

3. **æ·»åŠ ä¸åŒå•†å“**ï¼š
   - æ·»åŠ ä¸åŒçš„å•†å“åˆ°è´­ç‰©è½¦
   - æ£€æŸ¥è´­ç‰©è½¦ï¼Œåº”è¯¥æ˜¾ç¤ºå¤šè¡Œï¼Œæ¯è¡Œä¸€ä¸ªä¸åŒçš„å•†å“

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“æŸ¥è¯¢
- `findByUserIdAndProductId` æ–¹æ³•ä¼šæŸ¥è¯¢æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨è¯¥ç”¨æˆ·å’Œè¯¥å•†å“çš„è´­ç‰©è½¦é¡¹
- å¦‚æœå­˜åœ¨ï¼Œè¿”å› `Optional<CartItem>`ï¼Œå¦åˆ™è¿”å› `Optional.empty()`

### äº‹åŠ¡å¤„ç†
- ä½¿ç”¨ `@Transactional` ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- å¦‚æœæ›´æ–°å¤±è´¥ï¼Œæ•´ä¸ªæ“ä½œä¼šå›æ»š

### æ•°é‡ç´¯åŠ 
- æ–°æ•°é‡ = åŸæœ‰æ•°é‡ + æ–°æ·»åŠ çš„æ•°é‡
- ä¾‹å¦‚ï¼šåŸæœ‰ 2 ä¸ªï¼Œå†æ·»åŠ  3 ä¸ªï¼Œæœ€ç»ˆä¸º 5 ä¸ª

---

**ä¿®å¤å®Œæˆï¼** ç°åœ¨è´­ç‰©è½¦ä¼šæ­£ç¡®åˆå¹¶é‡å¤å•†å“ã€‚ğŸ‰

